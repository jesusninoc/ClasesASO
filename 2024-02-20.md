# Práctica

## Instalar el rol de Directorio Activo, crear una estructura de dominio, instalar IIS y permitir que se pueda acceder al IIS mediante usuario y contraseña creados anteriormente en el Directorio Activo
- Instalar el rol de Directorio Activo: Add-WindowsFeature AD-Domain-Services
  - https://www.jesusninoc.com/03/02/instalacion-de-los-servicios-de-dominio-de-active-directory-desde-powershell/
- Crear dominio
  - https://www.jesusninoc.com/01/08/ejercicios-de-powershell-instalar-windows-active-directory-desde-powershell/ 
- Instalar IIS
  - https://www.jesusninoc.com/03/02/instalar-iis-en-powershell/
  - https://www.jesusninoc.com/02/15/crear-un-sitio-en-iis-con-powershell/
  - https://www.jesusninoc.com/06/22/ejercicios-de-powershell-crear-varios-sitios-web-para-varios-clientes-cuyos-nombres-estan-en-un-fichero/
- Crear usuarios en Directorio Activo
  - https://www.jesusninoc.com/05/03/creacion-masiva-de-usuarios-en-el-directorio-activo-con-powershell-parte-1/
- Configurar IIS para que solo se pueda acceder a un directorio con usuarios del Directorio Activo
  - https://www.jesusninoc.com/03/02/cambiar-la-autenticacion-en-un-sitio-web-del-iis-en-windows-10/
  - https://www.jesusninoc.com/03/02/cambiar-la-autenticacion-por-comandos-de-powershell-en-un-sitio-web-del-iis-en-windows-10/
- Probar que solo se puede acceder con usuarios del Directorio Activo desde PowerShell

## Subir documentos
* https://docs.microsoft.com/es-es/troubleshoot/developer/webapps/aspnet/development/upload-file-to-web-site
```PowerShell
[Microsoft.VisualBasic.Devices.Computer]::new().Network.UploadFile("C:\Users\jnino\2020-11-26.txt","http://localhost/subir2.html")
```

----------------------

# Serializar con PowerShell
* https://www.jesusninoc.com/09/24/serializar-y-deserializar-un-objeto-en-powershell-clixml/
* https://www.jesusninoc.com/02/03/serializar-una-dll-con-powershell-para-enviarla-por-red-mediante-udp-o-tcp/

# Ayuda DLL (enviar DLL y utilizarla)
* https://www.jesusninoc.com/02/28/crear-compilar-y-ejecutar-una-dll-con-microsoft-visual-c-que-crea-dos-metodos-que-abren-notepad-llamando-a-powershell-despues-llamar-a-los-metodos-desde-powershell/
* https://www.jesusninoc.com/02/28/enviar-una-dll-entre-un-cliente-y-un-servidor-por-udp-desde-powershell-ejecutar-un-metodo-de-la-dll-para-comprobar-que-ha-llegado-correctamente/

--------------------
--------------------

# Scripts

## Instalar el rol de Directorio Activo, crear una estructura de dominio, instalar IIS y permitir que se pueda acceder al IIS mediante usuario y contraseña creados anteriormente en el Directorio Activo
- Instalar el rol de Directorio Activo: Add-WindowsFeature AD-Domain-Services
  - https://www.jesusninoc.com/03/02/instalacion-de-los-servicios-de-dominio-de-active-directory-desde-powershell/
- Crear dominio
  - https://www.jesusninoc.com/01/08/ejercicios-de-powershell-instalar-windows-active-directory-desde-powershell/ 
- Instalar IIS
  - https://www.jesusninoc.com/03/02/instalar-iis-en-powershell/
  - https://www.jesusninoc.com/02/15/crear-un-sitio-en-iis-con-powershell/
  - https://www.jesusninoc.com/06/22/ejercicios-de-powershell-crear-varios-sitios-web-para-varios-clientes-cuyos-nombres-estan-en-un-fichero/
- Crear usuarios en Directorio Activo
  - https://www.jesusninoc.com/05/03/creacion-masiva-de-usuarios-en-el-directorio-activo-con-powershell-parte-1/
- Configurar IIS para que solo se pueda acceder a un directorio con usuarios del Directorio Activo
  - https://www.jesusninoc.com/03/02/cambiar-la-autenticacion-en-un-sitio-web-del-iis-en-windows-10/
  - https://www.jesusninoc.com/03/02/cambiar-la-autenticacion-por-comandos-de-powershell-en-un-sitio-web-del-iis-en-windows-10/
- Probar que solo se puede acceder con usuarios del Directorio Activo desde PowerShell

## Subir documentos
* https://docs.microsoft.com/es-es/troubleshoot/developer/webapps/aspnet/development/upload-file-to-web-site
```PowerShell
[Microsoft.VisualBasic.Devices.Computer]::new().Network.UploadFile("C:\Users\jnino\2020-11-26.txt","http://localhost/subir2.html")
```

----------------------

# Serializar con PowerShell
* https://www.jesusninoc.com/09/24/serializar-y-deserializar-un-objeto-en-powershell-clixml/
* https://www.jesusninoc.com/02/03/serializar-una-dll-con-powershell-para-enviarla-por-red-mediante-udp-o-tcp/

# Ayuda DLL (enviar DLL y utilizarla)
* https://www.jesusninoc.com/02/28/crear-compilar-y-ejecutar-una-dll-con-microsoft-visual-c-que-crea-dos-metodos-que-abren-notepad-llamando-a-powershell-despues-llamar-a-los-metodos-desde-powershell/
* https://www.jesusninoc.com/02/28/enviar-una-dll-entre-un-cliente-y-un-servidor-por-udp-desde-powershell-ejecutar-un-metodo-de-la-dll-para-comprobar-que-ha-llegado-correctamente/

----------------------
----------------------

# Scripts

## Instalar el rol de Directorio Activo, crear una estructura de dominio, instalar IIS y permitir que se pueda acceder al IIS mediante usuario y contraseña creados anteriormente en el Directorio Activo
- Instalar el rol de Directorio Activo: Add-WindowsFeature AD-Domain-Services
  - https://www.jesusninoc.com/03/02/instalacion-de-los-servicios-de-dominio-de-active-directory-desde-powershell/
- Crear dominio
  - https://www.jesusninoc.com/01/08/ejercicios-de-powershell-instalar-windows-active-directory-desde-powershell/ 
- Instalar IIS
  - https://www.jesusninoc.com/03/02/instalar-iis-en-powershell/
  - https://www.jesusninoc.com/02/15/crear-un-sitio-en-iis-con-powershell/
  - https://www.jesusninoc.com/06/22/ejercicios-de-powershell-crear-varios-sitios-web-para-varios-clientes-cuyos-nombres-estan-en-un-fichero/
- Crear usuarios en Directorio Activo
  - https://www.jesusninoc.com/05/03/creacion-masiva-de-usuarios-en-el-directorio-activo-con-powershell-parte-1/
- Configurar IIS para que solo se pueda acceder a un directorio con usuarios del Directorio Activo
  - https://www.jesusninoc.com/03/02/cambiar-la-autenticacion-en-un-sitio-web-del-iis-en-windows-10/
  - https://www.jesusninoc.com/03/02/cambiar-la-autenticacion-por-comandos-de-powershell-en-un-sitio-web-del-iis-en-windows-10/
- Probar que solo se puede acceder con usuarios del Directorio Activo desde PowerShell

## Subir documentos
* https://docs.microsoft.com/es-es/troubleshoot/developer/webapps/aspnet/development/upload-file-to-web-site
```PowerShell
[Microsoft.VisualBasic.Devices.Computer]::new().Network.UploadFile("C:\Users\jnino\2020-11-26.txt","http://localhost/subir2.html")
```

----------------------

# Serializar con PowerShell
* https://www.jesusninoc.com/09/24/serializar-y-deserializar-un-objeto-en-powershell-clixml/
* https://www.jesusninoc.com/02/03/serializar-una-dll-con-powershell-para-enviarla-por-red-mediante-udp-o-tcp/

# Ayuda DLL (enviar DLL y utilizarla)
* https://www.jesusninoc.com/02/28/crear-compilar-y-ejecutar-una-dll-con-microsoft-visual-c-que-crea-dos-metodos-que-abren-notepad-llamando-a-powershell-despues-llamar-a-los-metodos-desde-powershell/
* https://www.jesusninoc.com/02/28/enviar-una-dll-entre-un-cliente-y-un-servidor-por-udp-desde-powershell-ejecutar-un-metodo-de-la-dll-para-comprobar-que-ha-llegado-correctamente/

----------------------
----------------------

# Modelos de examen
* Crear usuarios, comprobar que no existen, crear carpetas para cada uno que estén compartidas.
* Procesos.
* Sistema de archivos.
* Acceso remoto.
* Servidores de impresión. Controlar impresión.
* DFS.

----------
----------

# Examen

## Crear la estructura de red del Centro leyendo de un fichero, teniendo en cuenta:
- Hay seis grupos de clases, seis unidades organizativas
- Hay que crear usuarios y grupos para cada clase
- Hay que deshabilitar usuarios y moverlos a la unidad organizativa de los deshabilitados
- Borrar unidades organizativas

## Una vez creada la estructura y los usuarios funcionando (crear funciones para cada punto):
- Para cada usuario instalar el software que te parezca
- Para un usuario controlar la impresión que realiza
- Para cada usuario controlar que no ejecuta más de 10 procesos
- Realizar una copia de seguridad cada vez que se modifica el fichero
- El fichero con la estructura viene de una carpeta compartida (acceso remoto a la máquina)

## Soluciones
* https://github.com/MikeRuSe/Scripts/blob/master/2020_02_07-AD_Structure.ps1
* https://github.com/manuanton/Ejercicios/blob/master/ExamenASO%2007-02-2020
* https://github.com/Kinon4/powershell/blob/master/Examen%20ASO%2007-02.md

-------------
-------------

# Repaso examen
* https://github.com/jesusninoc/ClasesASO/blob/master/2020-02-07.md

## Leer operaciones de un fichero
```PowerShell
gc .\operaciones.txt | %{
    switch($_.split(",")[0])
    {
        "ou"{"es ou"}
        "group"{"es grupo"}
        "user"{"es user"}
    }
}
```

## Una vez creada la estructura y los usuarios funcionando (crear funciones para cada punto):
- Para cada usuario instalar el software que te parezca
```PowerShell
function instalar($aplicacion){
    foreach($ordenador in (Get-ADComputer -Filter * | select name).name | Select-String "win*"){
        Invoke-Command -ComputerName $ordenador -ScriptBlock {Install-Package $aplicacion}
    }
}

instalar zoomit
```
- Para un usuario controlar la impresión que realiza
```PowerShell
function comprobar($user){
    foreach ($trabajo in Get-PrintJob "Brother Color Leg Type1 Class Driver")
    {
        if($trabajo.Size -gt 1KB)
        {
            if($trabajo.UserName -EQ $user)
            {
                "ES MAYOR, LO ELIMINO"
                $trabajo.Id
                Remove-PrintJob -ID $trabajo.Id -PrinterName "Brother Color Leg Type1 Class Driver"
            }
        }
    }
}
```
- Para cada usuario controlar que no ejecuta más de 10 procesos
```PowerShell
function controlprocesos($numero){
    foreach($usuarios in (Get-Process -IncludeUserName * | select UserName).UserName | Group-Object)
    {
        if($usuarios.Count -gt $numero)
        {
            $usuarios
        }
    }
}
```
- Realizar una copia de seguridad cada vez que se modifica el fichero
```PowerShell
# Simulación de directorios y ficheros
mkdir carpeta1
"hola" | Out-File .\carpeta1\hola.txt
Copy-Item .\carpeta1 .\carpeta2 -Recurse

# Creación de la función
function comparardirectorios($carpeta1,$carpeta2)
{
    foreach($fichero in ls $carpeta1)
    {
        foreach($ficheroc in ls $carpeta2)
        {
            if($fichero.LastWriteTime -gt $ficheroc.LastWriteTime)
            {
                "SON DISTINTOS Y EL FICHERO1 ES MÁS NUEVO QUE FICHERO 2", $fichero.LastWriteTime, $ficheroc.LastWriteTime
                Copy-Item $carpeta1\$fichero $carpeta2
            
            }
            elseif($fichero.LastWriteTime -lt $ficheroc.LastWriteTime)
            {
                "SON DISTINTOS Y EL FICHERO2 ES MÁS NUEVO QUE FICHERO 1", $fichero.LastWriteTime, $ficheroc.LastWriteTime
                Copy-Item $carpeta2\$ficheroc $carpeta1
            }
            else
            {
               "SON IGUALES", $fichero.LastWriteTime, $ficheroc.LastWriteTime
            }
        }
    }
}

comparardirectorios .\carpeta1 .\carpeta2
```
- El fichero con la estructura viene de una carpeta compartida (acceso remoto a la máquina)
```PowerShell
New-SmbShare -Name k -Path C:\creacion
cd \\localhost\k
gc usuarios.txt
```

## Crear un script que permita crear un fichero que haga los siguientes pasos para cada usuario (y luego probarlo con tu otro script de creación):
- Crear usuario con password
- Meterlo en un grupo
- Meterlo en una unidad organizativa
- Crear ua carpeta compartida para cada usuario

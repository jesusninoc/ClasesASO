# Scripting
- Preguntas tema scripting https://github.com/jesusninoc/ClasesASO/blob/master/2025-12-01.md#preguntas-tema-scripting
- Curso acelerado de PowerShell https://www.jesusninoc.com/11/22/curso-online-de-powershell-diciembre-2025/
- Cron y tarea programada.
- Automatización
```PowerShell
# 1) Lista los 5 procesos que más CPU consumen
Get-Process |
    Sort-Object CPU -Descending |
    Select-Object -First 5 Id, ProcessName, CPU

# 2) Reinicia el servicio "Spooler" si está detenido
$servicio = Get-Service "Spooler"
if ($servicio.Status -eq "Stopped") {
    Start-Service "Spooler"
    $resultado = "El servicio Spooler estaba detenido y se ha iniciado."
} else {
    $resultado = "El servicio Spooler ya estaba iniciado."
}

# 3) Guarda la fecha y el resultado en un archivo de log
$fecha = Get-Date
$linea = "$fecha - $resultado"
$linea | Out-File -FilePath "C:\mantenimiento.log" -Append
```
```Bash
#!/bin/bash

service="apache2"
mail_to="admin@midominio.com"   # Cambia esto por tu correo

if ! systemctl is-active --quiet "$service"; then
    systemctl restart "$service"

    mensaje="$(date): Reinicio de $service en $(hostname)"

    echo "$mensaje" >> /var/log/mantenimiento.log

    echo "$mensaje" | mail -s "Reinicio automático de $service" "$mail_to"
fi

```
- Usar AWS CLI
```Bash
#!/bin/bash

# ID de la instancia EC2 a monitorizar
INSTANCE_ID="i-0edbc195ff828707f"

# Comprobar estado de la instancia EC2
estado=$(aws ec2 describe-instance-status \
  --instance-ids "$INSTANCE_ID" \
  --query 'InstanceStatuses[0].InstanceState.Name' \
  --output text 2>/dev/null)

# Si no está "running", escribimos en log e intentamos arrancarla
if [ "$estado" != "running" ]; then
  echo "$(date '+%Y-%m-%d %H:%M:%S'): Instancia $INSTANCE_ID no disponible (estado: $estado). Reiniciando..." >> /var/log/aws_monitor.log
  aws ec2 start-instances --instance-ids "$INSTANCE_ID" >> /var/log/aws_monitor.log 2>&1
else
  # Si está en running, lo mostramos por pantalla
  echo "$(date '+%Y-%m-%d %H:%M:%S'): La instancia $INSTANCE_ID está arrancada (estado: $estado)."
fi
```
- Configura AWS CLI y Azure CLI (script de simulación)
```Bash
#!/bin/bash

LOG_FILE="multi_cloud_monitor.log"
NOW=$(date +"%Y-%m-%d %H:%M:%S")

########################################
# 0) Crear ficheros mock si no existen
########################################

if [ ! -f aws_ec2_mock.txt ]; then
  cat << 'EOF' > aws_ec2_mock.txt
i-11111111111111111 running
i-22222222222222222 stopped
i-33333333333333333 running
EOF
fi

if [ ! -f azure_vm_mock.txt ]; then
  cat << 'EOF' > azure_vm_mock.txt
vm-lab-1    VM running
vm-lab-2    VM stopped
vm-lab-3    VM deallocated
EOF
fi

echo "[$NOW] ---- Nueva ejecución ----" >> "$LOG_FILE"

########################################
# 1) AWS – EC2
########################################

AWS_OUTPUT=""
AWS_SOURCE="none"

if command -v aws >/dev/null 2>&1; then
  # Intento real con AWS CLI
  AWS_OUTPUT=$(aws ec2 describe-instances \
    --query "Reservations[].Instances[].{Id:InstanceId,State:State.Name}" \
    --output text 2>/dev/null)

  if [ $? -ne 0 ] || [ -z "$AWS_OUTPUT" ]; then
    # Sin permisos, sin cuenta o sin instancias: usar mock
    AWS_OUTPUT=$(cat aws_ec2_mock.txt)
    AWS_SOURCE="mock"
  else
    AWS_SOURCE="cli"
  fi
else
  # AWS CLI no está instalado: usar mock
  AWS_OUTPUT=$(cat aws_ec2_mock.txt)
  AWS_SOURCE="mock-cli-not-found"
fi

if [ "$AWS_SOURCE" != "none" ]; then
  # Contar instancias running y detenidas (stopped/terminadas)
  RUNNING_AWS=$(echo "$AWS_OUTPUT" | awk '$2 ~ /running/i {c++} END {print c+0}')
  STOPPED_AWS=$(echo "$AWS_OUTPUT" | awk '$2 ~ /stopped|terminated|shutting-down/i {c++} END {print c+0}')

  echo "[$NOW] AWS ($AWS_SOURCE) - Instancias running: $RUNNING_AWS, stopped/otras: $STOPPED_AWS" | tee -a "$LOG_FILE"

  # Registrar detalle
  echo "$AWS_OUTPUT" | awk -v ts="$NOW" '{printf "[%s] AWS - %s %s\n", ts, $1, $2}' >> "$LOG_FILE"
else
  echo "[$NOW] AWS - No se ha podido obtener información (ni CLI ni mock)" | tee -a "$LOG_FILE"
fi

########################################
# 2) Azure – VMs
########################################

AZ_OUTPUT=""
AZ_SOURCE="none"

if command -v az >/dev/null 2>&1; then
  # Intento real con Azure CLI
  AZ_OUTPUT=$(az vm list -d \
    --query "[].{Name:name,PowerState:powerState}" \
    --output tsv 2>/dev/null)

  if [ $? -ne 0 ] || [ -z "$AZ_OUTPUT" ]; then
    # Sin login, sin suscripción o sin VMs: usar mock
    AZ_OUTPUT=$(cat azure_vm_mock.txt)
    AZ_SOURCE="mock"
  else
    AZ_SOURCE="cli"
  fi
else
  # Azure CLI no está instalado: usar mock
  AZ_OUTPUT=$(cat azure_vm_mock.txt)
  AZ_SOURCE="mock-cli-not-found"
fi

if [ "$AZ_SOURCE" != "none" ]; then
  # Contar VMs activas y detenidas usando toda la línea (porque "VM running" son dos palabras)
  RUNNING_AZ=$(echo "$AZ_OUTPUT" | awk '$0 ~ /running/i {c++} END {print c+0}')
  STOPPED_AZ=$(echo "$AZ_OUTPUT" | awk '$0 ~ /stopped|deallocated/i {c++} END {print c+0}')

  echo "[$NOW] Azure ($AZ_SOURCE) - VMs running: $RUNNING_AZ, stopped/deallocated: $STOPPED_AZ" | tee -a "$LOG_FILE"

  # Registrar detalle por VM (primera columna = nombre, resto = estado)
  echo "$AZ_OUTPUT" | awk -v ts="$NOW" '{
    name = $1
    $1 = ""
    # $0 ahora contiene el estado con espacios: " VM running", etc.
    gsub(/^ +/, "", $0)
    printf "[%s] Azure - %s %s\n", ts, name, $0
  }' >> "$LOG_FILE"
else
  echo "[$NOW] Azure - No se ha podido obtener información (ni CLI ni mock)" | tee -a "$LOG_FILE"
fi

echo "[$NOW] ---- Fin de ejecución ----" >> "$LOG_FILE"
```

---------------

# Preguntas clase anterior

¿Qué hace el comando en PowerShell
Get-Process | Sort-Object CPU -Descending | Select-Object -First 5 Id, ProcessName, CPU?
a) Muestra todos los servicios instalados
b) Muestra los 5 procesos que más CPU consumen con su Id, nombre y CPU
c) Elimina los 5 procesos que más CPU usan

En el comando Sort-Object CPU -Descending, ¿qué significa -Descending?
a) Ordenar de menor a mayor
b) Ordenar alfabéticamente por nombre
c) Ordenar de mayor a menor

En Select-Object -First 5 Id, ProcessName, CPU, ¿qué hace -First 5?
a) Selecciona los últimos 5 procesos
b) Selecciona solo los 5 primeros resultados
c) Selecciona 5 procesos al azar

En PowerShell, ¿qué hace $servicio = Get-Service "Spooler"?
a) Instala el servicio Spooler
b) Guarda en la variable $servicio la información sobre el servicio Spooler
c) Detiene el servicio Spooler

En la condición if ($servicio.Status -eq "Stopped") { ... }, ¿qué comprueba el script?
a) Si el servicio está en ejecución
b) Si el servicio está detenido
c) Si el servicio está desinstalado

En el bloque Start-Service "Spooler", ¿qué ocurre?
a) Se desinstala el servicio Spooler
b) Se inicia el servicio Spooler si está detenido
c) Se reinicia el equipo

En PowerShell, ¿qué hace Get-Date?
a) Muestra solo la hora del sistema
b) Muestra la fecha y hora actuales
c) Cambia la fecha del sistema

En Out-File -FilePath "C:\mantenimiento.log" -Append, ¿para qué sirve -Append?
a) Sobrescribe el archivo borrando el contenido anterior
b) Añade la nueva línea al final del archivo sin borrar lo anterior
c) Crea una copia de seguridad del archivo

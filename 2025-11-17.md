# Contenido de clase

## Posibles preguntas

¿Para qué se utiliza principalmente LDAP?
a) Para compartir carpetas entre Windows y Linux
b) Para acceder y consultar servicios de directorio
c) Para cifrar discos duros

¿Qué es Active Directory en relación con LDAP?
a) Un sistema de copias de seguridad
b) La implementación de Microsoft del estándar LDAP
c) Un servidor web de Microsoft

¿Qué protocolo usa Active Directory para la autenticación segura?
a) FTP
b) Kerberos
c) HTTP

¿Qué ventaja ofrece Kerberos frente a enviar la contraseña en cada conexión?
a) Usa tickets temporales y evita que la contraseña viaje por la red
b) Comprime los datos para que vayan más rápido
c) Cambia la contraseña automáticamente cada día

¿Para qué se utiliza DNS en un dominio con Active Directory?
a) Para compartir impresoras
b) Para localizar controladores de dominio y servicios
c) Para instalar actualizaciones de Windows

¿Qué componente en Linux actúa como “puente” con fuentes de identidad externas como AD o LDAP?
a) cron
b) SSSD
c) systemd

¿Qué herramienta de Samba permite a un sistema Linux usar usuarios y grupos de Active Directory?
a) Winbind
b) NFS
c) iptables

¿Qué comando ayuda a unir una máquina Linux a un dominio de forma sencilla?
a) top
b) realm (junto con adcli)
c) df

¿Qué comando se utiliza para obtener un ticket Kerberos para el usuario usuario@POWER.LOCAL
?
a) kinit usuario@POWER.LOCAL
b) klist usuario@POWER.LOCAL
c) ssh usuario@POWER.LOCAL

¿Qué muestra el comando klist?
a) Los usuarios conectados al sistema
b) Los tickets Kerberos activos en la sesión
c) Los procesos que usan más CPU

¿Qué hace el comando ldapsearch en este contexto?
a) Buscar objetos en el servicio de directorio mediante LDAP
b) Escanear puertos abiertos en la red
c) Crear usuarios en Active Directory

En Samba, el parámetro valid users = @grupo_docs indica que pueden acceder a la carpeta compartida:
a) Solo los usuarios invitados
b) Solo el usuario root
c) Solo los usuarios pertenecientes al grupo grupo_docs

¿Qué ruta se utiliza desde Windows para acceder a la carpeta compartida docs en un servidor Samba?
a) C:\docs\servidor
b) \<IP_DEL_SERVIDOR>\docs
c) http://<IP_DEL_SERVIDOR>/docs

¿Qué comando en Linux permite comprobar si otro equipo de la red responde a nivel básico de conectividad?
a) ping <IP_DEL_EQUIPO>
b) ssh <IP_DEL_EQUIPO>
c) net use <IP_DEL_EQUIPO>

Si desde Windows no puedes montar \<IP_DEL_SERVIDOR>\docs, ¿qué comando puedes usar en el servidor Linux para probar el recurso Samba localmente?
a) smbclient //127.0.0.1/docs -U usuario1
b) ftp 127.0.0.1
c) telnet 127.0.0.1 80

-----------
-----------

- LDAP es un protocolo abierto y estándar utilizado para acceder a servicios de directorio (ldapsearch -x -b "dc=empresa,dc=com" "(uid=juan.perez)").
- Active Directory es la implementación de Microsoft del estándar LDAP (necesita: LDAP para la estructura jerárquica de objetos (usuarios, grupos, unidades organizativas); Kerberos para la autenticación segura, basada en tickets temporales que evitan el envío de contraseñas por la red (este usuario ya ha demostrado quién es. Déjale entrar hasta tal hora); DNS para localizar controladores de dominio y servicios).
- Para que Linux y Windows "hablen el mismo idioma", se utilizan componentes como: SSSD (System Security Services Daemon) gestiona la autenticación y el almacenamiento
en caché de credenciales; Winbind componente del proyecto Samba que permite que un sistema Linux use usuarios y grupos definidos en AD; Realmd y adcli herramientas que facilitan la unión de una máquina Linux al dominio con un solo comando.

- Añadir Ubuntu Server al AD.
```
### Tener instalado un AD en Windows Server
- IP fija y sin puerta de enlace.
- Nombre de servidor (dc01).

### DNS en Ubuntu
sudo nano /etc/systemd/resolved.conf

[Resolve]
DNS=192.168.1.10
Domains=power.local

sudo systemctl restart systemd-resolved

dig power.local

### realm (para sacarlo del dominio usar sudo realm leave)
sudo apt update
sudo apt install realmd sssd krb5-user samba-common-bin oddjob oddjob-mkhomedir adcli
# Configuración de krb5 -> nombre de Dominio POWER.LOCAL
# Configuring Kerberos Authentication ├──────────────────────────────┐
#   │ When users attempt to use Kerberos and specify a principal or user name without specifying what   │ 
#   │ administrative Kerberos realm that principal belongs to, the system appends the default realm.    │ 
#   │ The default realm may also be used as the realm of a Kerberos service running on the local        │ 
#   │ machine.  Often, the default realm is the uppercase version of the local DNS domain.              │ 
#   │                                                                                                   │ 
#   │ Default Kerberos version 5 realm:                          

realm discover POWER.LOCAL

sudo realm join --user=Administrador POWER.LOCAL
# Errores: journalctl REALMD_OPERATION=r1208.3124
# - Reloj
# - Contraseña mal puesta

realm list
```
- Kerberos en funcionamiento (Kerberos es un protocolo de autenticación que funciona con tickets cifrados y temporales. El usuario solo demuestra su contraseña al principio, localmente, y a partir de ahí usa tickets emitidos por un servidor de confianza (KDC) para acceder a los distintos servicios, evitando que la contraseña viaje por la red).
```
### Iniciar sesión
# SSSD servicio de Linux que hace de “puente” entre el sistema y fuentes de identidad externas, como Active Directory, LDAP, FreeIPA, etc., para que puedas usar usuarios y grupos de esos servidores para iniciar sesión (consola, SSH, sudo, etc.).
sudo systemctl status sssd

# Home para el usuario
# Qué “módulos de autenticación” se usan en el sistema (Unix local, SSSD, crear home, etc.) mediante un menú tipo checklist. Al aceptarlo, reconstruye los ficheros de PAM que usan login, SSH, sudo, etc.
sudo pam-auth-update
# PAM profiles to enable:                                                                            │ 
#  │                                                                                                    │ 
#  │  [*] Pwquality password strength checking                                                          │ 
#  │  [ ] SSS required smart card authentication                                                        │ 
#  │  [ ] SSS optional smart card authentication                                                        │ 
#  │  [*] Unix authentication                                                                           │ 
#  │  [*] SSS authentication                                                                            │ 
#  │  [*] Register user sessions in the systemd control group hierarchy                                 │ 
#  │  [*] Create home directory on login                                                                │ 
#  │  [*] Inheritable Capabilities Management  

# Es una forma de comprobar si Kerberos está funcionando bien entre tu servidor Linux y el controlador de dominio.
kinit usuario@POWER.LOCAL
# Muestra los tickets Kerberos que tienes actualmente en tu sesión.
klist

id usuario@power.local

ssh 'usuario@POWER.LOCAL'@localhost

### Objetos LDAP con ldapsearch
sudo apt install ldap-utils

ldapsearch -x -H ldap://WIN-8TBGIF849CB.power.local -D "usuario@POWER.LOCAL" -W -b "dc=power,dc=local"
```
- Carpeta compartida entre Linux y Windows
  - Samba es una implementación libre del protocolo SMB (Server Message Block), también conocido como CIFS (Common Internet File System). 
  - Instala y configura Samba con una carpeta compartida /srv/docs.
  - Asigna permisos a un grupo específico.
  - Desde Windows, monta el recurso con \\servidor\docs.
```Bash
sudo apt update
sudo apt install samba -y

sudo mkdir -p /srv/docs

sudo groupadd grupo_docs
sudo chown :grupo_docs /srv/docs
sudo chmod 2770 /srv/docs

sudo useradd -m usuario1
sudo passwd usuario1
sudo usermod -aG grupo_docs usuario1

sudo nano /etc/samba/smb.conf

[docs]
   path = /srv/docs
   browseable = yes
   writable = yes
   valid users = @grupo_docs
   create mask = 0660
   directory mask = 0770
   comment = Carpeta compartida de documentos

sudo smbpasswd -a usuario1
sudo smbpasswd -e usuario1

sudo systemctl restart smbd
sudo systemctl enable smbd

\\<IP_DEL_SERVIDOR>\docs
# Si falla (en Linux)
smbclient //127.0.0.1/docs -U usuario1
# Si falla (en Windows)
net use \\<IP_DEL_SERVIDOR>\docs /user:usuario1 *
```

------------
------------

# Scripting
- Pedir nombre y mostrar mensaje en PowerShell y Bash.
```PowerShell
$name = Read-Host "Escribe tu nombre"

if ($name) {
    Write-Host "Hola, $name!"
} else {
    Write-Host "No escribiste tu nombre."
}
```
```Bash
read -p "Escribe tu nombre: " name

if [ -n "$name" ]; then
    echo "Hola, $name!"
else
    echo "No escribiste tu nombre."
fi
```
- Crea un script Bash o PowerShell que:
  - Liste los procesos que consumen más CPU.
  - Reinicie automáticamente un servicio si está detenido.
  - Guarde la fecha y resultado en un archivo de log.
- Cron y tarea programada.
- Configura AWS CLI y Azure CLI con cuentas de prueba (modo CLI offline).
  - AWS
```
aws ec2 run-instances --image-id ami-123456 --count 1 --instance-type t2.micro --dry-run
```
- Script profesional validado y seguro.

# Tareas
- Tarea: instalar Ubuntu Server y Windows Server 2022.

# Contenido de clase

- Túnel SSH del 8080 al 80 (Putty).
  - Acceder desde tu máquina local (localhost) al servidor Apache en un servidor remoto: https://www.youtube.com/watch?v=BNE4pSd9a_M
  - Crear un túnel SSH para usar un servidor remoto como salida a Internet https://www.youtube.com/watch?v=Ro9X-ZWtXeU
- Impresión en Windows y Linux

## Impresión en Windows y Linux

- Instalar el rol
- Instalar una impresora genérica
- Órdenes para la gestión de impresoras y trabajos
  - https://docs.microsoft.com/en-us/powershell/module/printmanagement/?view=win10-ps
  - http://www.penguintutor.com/linux/printing-reference
- Ejercicio: simular y controlar una cola de impresión
  - Añadir una impresora
  - Ver los trabajos enviados a la impresora: Get-PrintJob
  - Eliminar un trabajo enviado a la impresora: Remove-PrintJob
- Órdenes para la gestión de impresoras y trabajos
  - https://docs.microsoft.com/en-us/powershell/module/printmanagement/?view=win10-ps
- Características
  - BranchOfficeOfflineLogSizeMB: Specifies the maximum size, in megabytes, of the branch office remote offline log file for this printer. You cannot specify this parameter for unshared queues or queues that do not have branch office enabled.
  - ConnectionName: specifies the name of a shared printer to which to connect. This parameter is required.
  - DeviceURL: specifies a URL for directed discovery of Web Services on Devices (WSD) printer to add to the specified computer.
  - DeviceUUID: pecifies the multicast UUID for device detection for the WSD port.
  - DriverName: specifies the name of the printer driver for the printer.
  - KeepPrintedJobs: specifies whether the print jobs in the queue are kept.
  - Location: specifies the location of the printer.
  - Name: specifies the name of the printer to add.
  - PermissionSDDL: specifies the permissions for the printer as a Security Descriptor Definition Language (SDDL) string.
  - PortName: specifies the name of the port that is used or created for the printer.
  - Priority: specifies the relative queue priority.
  - ShareName: specifies the name by which to share the printer on the network. To share a printer, specify the Shared parameter.
  - Shared: indicates whether to share the printer on the network. You can determine the name by which the printer is shared by specifying ShareName. If ShareName is not specified, the name of the printer is used as the share name.
  - StartTime: specifies the starting time of printer availability.
  - UntilTime: specifies the ending time of printer availability.
- Añadir una impresora
  - https://docs.microsoft.com/en-us/powershell/module/printmanagement/add-printer?view=win10-ps
  - https://www.jesusninoc.com/01/19/anadir-una-impresora-desde-powershell/
- Simular y controlar varias colas de impresión para varias impresoras (eliminar los trabajos cuyo tamaño sean superiores a 100 MB y los usuarios que han mandado el trabajo no sean el usuario administrador)
  - https://www.jesusninoc.com/01/26/ejercicios-de-powershell-simular-y-controlar-varias-colas-de-impresion-para-varias-impresoras-eliminar-los-trabajos-cuyo-tamano-sean-superiores-a-100-mb-y-los-usuarios-que-han-mandado-el-trabajo-no/
- Ver los trabajos enviados a la impresora
  - https://docs.microsoft.com/en-us/powershell/module/printmanagement/get-printjob?view=win10-ps
- Eliminar un trabajo enviado a la impresora
  - https://docs.microsoft.com/en-us/powershell/module/printmanagement/remove-printjob?view=win10-ps
- Instalar CUPS en Ubuntu
- Ejercicio: añadir la impresora de PDF en CUPS e imprimir desde un Windows con PowerShell
- Imprimir un archivo de texto
```Bash
cat imprimir | lpr
```
- Ver cola de impresión
```Bash
lpq
```
- Borrar cola de impresión
```Bash
lprm -
```

-------------

# Proyecto de la unidad (aplicación sobre impresión con backdoor)
* https://www.jesusninoc.com/01/19/anadir-una-impresora-desde-powershell/
* https://www.jesusninoc.com/06/12/crear-un-formulario-en-html-y-un-fichero-en-php-que-permita-subir-una-imagen-o-fichero-o-lo-que-sea-a-un-servidor-web/
* https://www.jesusninoc.com/06/05/crear-un-servidor-web-con-un-servicio-que-permita-leer-un-codigo-qr-desde-powershell/
* https://www.jesusninoc.com/06/01/crear-y-leer-un-codigo-qr-con-un-comando-en-bash-mediante-wsl-desde-powershell/
* https://www.jesusninoc.com/05/29/enviar-cmdlets-entre-un-cliente-y-un-servidor-leyendo-de-un-fichero/
* https://www.jesusninoc.com/02/01/convertir-un-script-de-powershell-en-un-ejecutable-de-windows-convertir-un-formulario-en-powershell/

----------
----------

# Contenido de clase

- VPN https://www.wireguard.com/install/
- Añadir Ubuntu Server al AD.
```
### Tener instalado un AD en Windows Server
- IP fija y sin puerta de enlace.
- Nombre de servidor (dc01).

### DNS en Ubuntu
sudo nano /etc/systemd/resolved.conf

[Resolve]
DNS=192.168.1.10
Domains=power.local

sudo systemctl restart systemd-resolved

dig power.local

### realm
sudo apt update
sudo apt install realmd sssd krb5-user samba-common-bin oddjob oddjob-mkhomedir adcli
# Configuración de krb5 -> nombre de Dominio POWER.LOCAL
# Configuring Kerberos Authentication ├──────────────────────────────┐
#   │ When users attempt to use Kerberos and specify a principal or user name without specifying what   │ 
#   │ administrative Kerberos realm that principal belongs to, the system appends the default realm.    │ 
#   │ The default realm may also be used as the realm of a Kerberos service running on the local        │ 
#   │ machine.  Often, the default realm is the uppercase version of the local DNS domain.              │ 
#   │                                                                                                   │ 
#   │ Default Kerberos version 5 realm:                          

realm discover POWER.LOCAL

sudo realm join --user=Administrador POWER.LOCAL
# Errores: journalctl REALMD_OPERATION=r1208.3124
# - Reloj
# - Contraseña mal puesta

realm list
```
- Crear recurso compartido en Ubuntu Server para ver desde Windows (compartir, permisos, c$, localhost)
- Kerberos en funcionamiento.
```
### Iniciar sesión
sudo systemctl status sssd

# Home para el usuario
sudo pam-auth-update
# PAM profiles to enable:                                                                            │ 
#  │                                                                                                    │ 
#  │  [*] Pwquality password strength checking                                                          │ 
#  │  [ ] SSS required smart card authentication                                                        │ 
#  │  [ ] SSS optional smart card authentication                                                        │ 
#  │  [*] Unix authentication                                                                           │ 
#  │  [*] SSS authentication                                                                            │ 
#  │  [*] Register user sessions in the systemd control group hierarchy                                 │ 
#  │  [*] Create home directory on login                                                                │ 
#  │  [*] Inheritable Capabilities Management  

kinit usuario@POWER.LOCAL
klist

id usuario@power.local

ssh 'usuario@POWER.LOCAL'@localhost

### Objetos LDAP con ldapsearch
sudo apt install ldap-utils

ldapsearch -x -H ldap://WIN-8TBGIF849CB.power.local -D "usuario@POWER.LOCAL" -W -b "dc=power,dc=local"
```
- Instala Zabbix Server y agente en un Windows y un Linux. Crea un trigger para alertar si CPU > 80%.
```
# Instalación del Zabbix Agent en Windows

- Descarga el agente desde:
https://www.zabbix.com/download_agents

- Extrae el archivo descargado y abre una terminal (cmd) en la carpeta donde está el agente.

- Ejecuta estos comandos para instalar el agente como servicio y arrancarlo:

zabbix_agentd.exe --config zabbix_agentd.conf --install
zabbix_agentd.exe --start

- Edita el archivo zabbix_agentd.conf y configura estas líneas:

Server=IP_DEL_ZABBIX
ServerActive=IP_DEL_ZABBIX
Hostname=NOMBRE_DEL_HOST

# Crear un trigger para alertar si la CPU > 80%

- A. Accede a la interfaz web de Zabbix desde el navegador:

http://IP_DEL_SERVIDOR/zabbix

Usuario: Admin
Contraseña: zabbix

- B. Agrega hosts

En el menú, ve a: Configuration > Hosts > Create host

Crea un host para Linux y otro para Windows.

Asocia estas plantillas a cada host según corresponda:
Template OS Linux by Zabbix agent
Template OS Windows by Zabbix agent

- C. Crear trigger personalizado

Ve a: Configuration > Hosts > Triggers

Selecciona el host al que quieres añadir el trigger.

Haz clic en Create trigger.

Configura los siguientes campos:

Nombre: Alta carga de CPU (>80%)
Severidad: High
Expresión: {NombreDelHost:system.cpu.util[,user].last()}>80

Alternativa para la métrica total agregada:

{NombreDelHost:system.cpu.util[].last()}>80

Guarda el trigger.
```

------------
------------

# Scripting
- Pedir nombre y mostrar mensaje en PowerShell y Bash.
```PowerShell
$name = Read-Host "Escribe tu nombre"

if ($name) {
    Write-Host "Hola, $name!"
} else {
    Write-Host "No escribiste tu nombre."
}
```
```Bash
read -p "Escribe tu nombre: " name

if [ -n "$name" ]; then
    echo "Hola, $name!"
else
    echo "No escribiste tu nombre."
fi
```
- Crea un script Bash o PowerShell que:
  - Liste los procesos que consumen más CPU.
  - Reinicie automáticamente un servicio si está detenido.
  - Guarde la fecha y resultado en un archivo de log.
- Cron y tarea programada.
- Configura AWS CLI y Azure CLI con cuentas de prueba (modo CLI offline).
  - AWS
```
aws ec2 run-instances --image-id ami-123456 --count 1 --instance-type t2.micro --dry-run
```
- Script profesional validado y seguro.
